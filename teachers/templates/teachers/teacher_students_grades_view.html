{% extends "teachers/teacher_dashboard.html" %}

{% block mainContent %}
<style>
.container {
  max-width: 900px;
  margin: 2rem auto;
  font-family: "Poppins", sans-serif;
}
.card {
  background: #fff;
  border-radius: 10px;
  padding: 1.5rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
}
.table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
.table th, .table td {
  padding: 0.6rem;
  border: 1px solid #ddd;
  text-align: left;
}
.table th {
  background: #f2f2f2;
}
h3, h5 {
  color: #333;
}
.btn {
  background: #0066cc;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
}
.btn:hover {
  background: #004d99;
}
.btn-secondary {
  background: #777;
}
.btn-secondary:hover {
  background: #555;
}
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.student-group-header {
  background-color: #e6f0ff;
  font-weight: bold;
  border-top: 3px solid #0066cc;
}
.student-summary {
  background: #fafafa;
  font-weight: 500;
  color: #333;
}
.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
.summary-table th, .summary-table td {
  border: 1px solid #ccc;
  padding: 0.6rem;
}
.summary-table th {
  background: #e6f0ff;
}
.summary-table caption {
  caption-side: top;
  font-weight: bold;
  margin-bottom: 0.5rem;
}
.form-container{
  text-align: center;
  padding: 20px 20%;
}
</style>

<div class="container">
  <h3>üìò Students Grades</h3>
  <div class="card form-container">
    <form method="get">
      <h5>Select Exam and Class</h5>
      {% if messages %}
  {% for message in messages %}
  {%if message.tags == 'error' %}
    <div style="color: red;">
    <span style="font-weight: bold;">{{message.tags}}:</span>  {{ message }}
    </div>
    {% else %}
    <div style="color: rgb(127, 182, 44);">
      <span style="font-weight: bold;">{{message.tags}}:</span>  {{ message }}
    </div>
    {% endif %}
  {% endfor %}
{% endif %}
      {{ selection_form.as_p }}
      <button type="submit" class="btn">View Grades</button>
    </form>
  </div>

  {% if selected_class %}
  <div class="top-bar">
    <h5>Class: {{ selected_class.name }}</h5>
    <a href="{% url 'teacher_students_grades_edit' %}?{{ request.GET.urlencode }}" class="btn">‚úèÔ∏è Edit Grades</a>
  </div>

  {% if own_class_results %}
  <div class="card">
    <h5>üìä Class Summary</h5>
    <table class="summary-table">
      <tbody>
        <tr><th>Class Mean Score</th><td>{{ class_mean_score }}</td></tr>
        <tr><th>Class Mean Grade</th><td>{{ class_mean_grade }}</td></tr>
        <tr><th>Class Average</th><td>{{ class_average }}</td></tr>
      </tbody>
    </table>

    {% if class_subjects_mean %}
    <table class="summary-table">
      <caption>Subject Mean Performance</caption>
      <thead>
        <tr><th>Subject</th><th>Mean Score</th><th>Mean Grade</th></tr>
      </thead>
      <tbody>
        {% for subject, subject_mean in class_subjects_mean.items %}
        <tr>
          <td>{{ subject }}</td>
          <td>{{ subject_mean.mean_score }}</td>
          <td>{{ subject_mean.mean_grade }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>

  <div class="card">
    <h5>My Class Results</h5>
    <table class="table">
      <thead>
        <tr><th>Student</th><th>Subject</th><th>Score</th><th>Grade</th><th>Remarks</th></tr>
      </thead>
      <tbody>
        {% for sdata in own_class_results %}
          <tr class="student-group-header">
            <td colspan="5">{{ sdata.position }}. {{ sdata.student }}</td>
          </tr>

          {% for r in sdata.records %}
          <tr>
            <td>&mdash;</td>
            <td>{{ r.subject }}</td>
            <td>{{ r.score }}</td>
            <td>{{ r.grade_object.grade }}</td>
            <td>{{ r.grade_object.remark }}</td>
          </tr>
          {% endfor %}

          <tr class="student-summary">
            <td colspan="2">üèÖ Position: {{ sdata.position }}</td>
            <td>Total: {{ sdata.total }}</td>
            <td>Average: {{ sdata.average }}</td>
            <td>Grade: {{ sdata.grade }} ({{ sdata.remark }})</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

 {% elif other_class_results %}
  <div class="card">
    <h5>üìä Other Class Results ‚Äî Subject Performance</h5>
 {% for subj in subject_ranked_results %}
  <div class="mt-3">
    <h6>{{ subj.subject }} ‚Äî Mean Score: {{ subj.mean_score }} ‚Äî Mean Grade: ({{ subj.mean_grade }})</h6>
    <table class="table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Student</th>
          <th>Score</th>
          <th>Grade</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody>
        {% for r in subj.records %}
        <tr>
          <td>{{ r.rank }}</td>
          <td>{{ r.student }}</td>
          <td>{{ r.score }}</td>
          <td>{{ r.grade }}</td>
          <td>{{ r.remark }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>
{% endif %}

  {% endif %}
</div>
{% endblock %}
