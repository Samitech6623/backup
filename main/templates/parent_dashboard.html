{% extends 'base.html' %}
{% load static %}

{% block head %}
{% block title %}<title>Parent Dashboard</title>{% endblock %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>
<link rel="stylesheet" href="{% static 'css/parent_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>Parent</h2>
        <ul>
            <li><a href="{% url 'parent_dashboard' %}">🏠 Dashboard</a></li>
<li><a href="{% url 'my_children' %}">👨‍🎓 My Children ({{ children.count }})</a></li>
            <li><a href="{% url 'parent_performance_page' %}">📊 Performance</a></li>
            <li><a href="{% url 'parent_fees_page' %}">💰 Fees</a></li>
            <li><a href="{% url 'events_page' %}">📅 Events ({{ events.count }})</a></li>
            <li><a href="#">📩 Messages ({{ messages.count }})</a></li>
            <li><a href="{% url 'portal_logout' %}">🚪 Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
         <div class="main-content">
     {% block main_content%}
        <h1>Welcome, {{ request.user.username|title }}</h1>
        <p>Role: Parent</p>

        {% for child in children %}
        <div class="childSection">
            <!-- Dashboard Cards -->
            <div class="cards">
                <div class="card">
                    <h3>Child: {{ child.display_name }}</h3>
                    <p>Class: {{ child.current_class }}</p>
                </div>
                <div class="card">
                    <h3>Attendance</h3>
                    <p>
                        {% if child.attendance_rate %}
                            {{ child.attendance_rate }}%
                        {% else %}
                            Not available
                        {% endif %}
                    </p>
                </div>
                <div class="card">
                    <h3>Latest Exam</h3>
                    <p>
    {% if child.latest_exam %}
    <p><strong>Exam:</strong> {{ current_exam.exam_name }}</p>
    <p><strong>Total Score:</strong> {{ child.total_score }}</p>
      <p><strong>Grade:</strong> {{ child.grade }}</p>

    {% else %}
        No exam records
    {% endif %}
</p>
                </div>
                <div class="card">
                    <h3>Fees Balance</h3>
                    <p>
                      <p>Fees Balance: KSH {{ child.balance }}</p>

                    </p>
                </div>
            </div>

            <!-- Performance Table -->
            <div class="table-section">
                <h2>Recent Exam Results</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Remark</th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in child.results.all %}
                {% if result.exam == current_exam %}
        <tr>
            <td>{{ result.subject }}</td>
            <td>{{ result.score }}</td>
            <td>{{ result.grade_object.grade }}</td>
            <td>{{ result.grade_object.remark }}</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    {% endif %}
                        {% empty %}
                        <tr><td colspan="3">No results available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
        <p>No children linked to this account.</p>
        {% endfor %}

        <!-- Events -->
        <div class="table-section" style="margin-top:20px;">
            <h2>Upcoming Events</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Event</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>{{ event.date|date:"d M Y" }}</td>
                        <td>{{ event.name }}</td>
                        <td>{{ event.location }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">No upcoming events</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Messages -->
        <div class="table-section" style="margin-top:20px;">
            <h2>Messages</h2>
            <ul>
                {% for msg in messages %}
                    <li>
                        <strong>{{ msg.title }}</strong> ({{ msg.created_at|date:"d M Y" }})<br>
                        {{ msg.content|truncatechars:100 }}
                    </li>
                {% empty %}
                    <li>No messages available</li>
                {% endfor %}
            </ul>
        </div>
    </div>

{% endblock %}
</div>

{% endblock %}
