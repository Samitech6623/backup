{% extends "teacher_dashboard.html" %}

{% block mainContent %}
<style>
/* ... (Your existing styles remain here) ... */
.container {
max-width: 900px;
margin: 2rem auto;
font-family: "Poppins", sans-serif;
}
.card {
background: #fff;
border-radius: 10px;
padding: 1.5rem;
box-shadow: 0 2px 6px rgba(0,0,0,0.1);
margin-bottom: 1.5rem;
}
.table {
width: 100%;
border-collapse: collapse;
margin-top: 1rem;
}
.table th, .table td {
padding: 0.6rem;
border: 1px solid #ddd;
text-align: left;
}
.table th {
background: #f2f2f2;
}
.table input {
width: 90%;
padding: 0.3rem;
border: 1px solid #bbb;
border-radius: 4px;
text-align: center;
}
h3, h5 {
color: #333;
}
.btn {
background: #0066cc;
color: white;
border: none;
padding: 0.6rem 1.2rem;
border-radius: 6px;
cursor: pointer;
text-decoration: none;
}
.btn:hover {
background: #004d99;
}
.btn-secondary {
background: #777;
}
.btn-secondary:hover {
background: #555;
}
.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
}

/* Style for the student name row (the first row for each student) */
.student-group-start {
  background-color: #e0e0e0;
  font-weight: bold;
  border-top: 3px solid #333; /* Stronger top line to separate students */
}

/* Style for rows that continue the current student */
.student-group-continue {
  background-color: #f7f7f7;
}

/* Ensure the first row of the table does not have the strong border */
.table tbody tr:first-child .student-group-start {
    border-top: none;
}

</style>

<div class="container">
  <h3>‚úèÔ∏è Edit Grades Inline</h3>

  {% if own_class_formset %}
  <form method="post">
    {% csrf_token %}
    {{ own_class_formset.management_form }}
    <div class="card">
      <table class="table">
        <thead>
          <tr><th>Student</th><th>Subject</th><th>Score</th></tr>
        </thead>
        <tbody>
          {% for form in own_class_formset %}
            
            {% with current_student=form.instance.student %}
            
              {# üîë Use ifchanged to visually group students and apply separators #}
              {% ifchanged current_student %}
                <tr class="student-group-start">
                    {# This row will display the student name prominently when it changes #}
                    <td colspan="3">
                        {{ current_student }}
                    </td>
                </tr>
              {% endifchanged %}

              <tr {% if form.errors %}style="border: 2px solid red;"{% endif %}>
                
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

                {# Use &mdash; to visually show the row belongs to the student named above #}
                <td>&mdash;</td>
                
                <td>{{ form.instance.subject }}</td>
                <td>
                  {{ form.score.errors }}
                  {{ form.score }}
                </td>

              </tr>
              
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn mt-2">üíæ Save All</button>
    </div>
  </form>

{% elif other_class_formset %}
  
  {# START: Logic for other_class_formset, replacing the comment #}
  <form method="post">
    {% csrf_token %}
    {{ other_class_formset.management_form }}
    <div class="card">
      <h5>Grading Subjects Taught in Other Classes</h5>
      <table class="table">
        <thead>
          <tr><th>Student</th><th>Subject</th><th>Score</th></tr>
        </thead>
        <tbody>
          {% for form in other_class_formset %}
            
            {% with current_student=form.instance.student %}
            
              {# Apply the exact same ifchanged logic for student grouping #}
              {% ifchanged current_student %}
                <tr class="student-group-start">
                    {# The colspan is set to the number of visible columns (3) #}
                    <td colspan="3">
                        {{ current_student }}
                    </td>
                </tr>
              {% endifchanged %}

              <tr {% if form.errors %}style="border: 2px solid red;"{% endif %}>
                
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

                {# Use &mdash; for the student column on subsequent subject rows #}
                <td>&mdash;</td>
                
                <td>{{ form.instance.subject }}</td>
                <td>
                  {{ form.score.errors }}
                  {{ form.score }}
                </td>

              </tr>
              
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn mt-2">üíæ Save Other Grades</button>
    </div>
  </form>
  {# END: Logic for other_class_formset #}
  
{% else %}
  <div class="card">
    <p>No results available for this selection.</p>
  </div>
{% endif %}

</div>
{% endblock %}