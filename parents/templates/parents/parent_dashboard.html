{% extends 'main/base.html' %}
{% load static %}

{% block head %}
    {% block title %}<title>Parent Dashboard</title>{% endblock %}
    <link rel="stylesheet" href="{% static 'css/parent_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>Parent</h2>

        <ul>
            {# Use request.resolver_match.url_name for active link styling #}
            {% with current_url=request.resolver_match.url_name %}
            
            <li class="{% if current_url == 'parent_dashboard' %}active{% endif %}">
                <a href="{% url 'parent_dashboard' %}">üè† Dashboard</a>
            </li>
            
            <li class="{% if current_url == 'my_children' %}active{% endif %}">
                <a href="{% url 'my_children' %}">üë®‚Äçüéì My Children ({{ children|length }})</a>
            </li>
            
            <li class="{% if current_url == 'parent_performance_page' %}active{% endif %}">
                <a href="{% url 'parent_performance_page' %}">üìä Performance</a>
            </li>
            
            <li class="{% if current_url == 'parent_fees_page' %}active{% endif %}">
                <a href="{% url 'parent_fees_page' %}">üí∞ Fees</a>
            </li>
            
            <li class="{% if current_url == 'events_page' %}active{% endif %}">
                <a href="{% url 'events_page' %}">üìÖ Events ({% firstof events|length 0 %})</a>
            </li>
            
            <li><a href="{% url 'portal_logout' %}">üö™ Logout</a></li>
            
            {% endwith %}
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        {% block main_content %}
        <h1>Welcome, {{ request.user.username|title }}</h1>
        <p>Role: Parent</p>

        {% for child in children %}
        <div class="childSection">
            <!-- Dashboard Cards -->
            <div class="cards">
                <div class="card">
                    <h3>Child: {{ child.display_name }}</h3>
                    <p>Class: {{ child.current_class }}</p>
                </div>
                <div class="card">
                    <h3>Attendance</h3>
                    <p>{{ child.attendance_rate|default:"Not available" }}%</p>
                </div>
                <div class="card">
                    <h3>Latest Exam</h3>
                    {% if child.latest_exam %}
                        <p><strong>Exam:</strong> {{ child.latest_exam.exam_name }}</p>
                        <p><strong>Total Score:</strong> {{ child.total_score }}</p>
                        <p><strong>Grade:</strong> {{ child.grade }}</p>
                        <p><strong>Remarks:</strong> {{ child.remark }}</p>
                    {% else %}
                        <p>No exam records</p>
                    {% endif %}
                </div>
                <div class="card">
                    <h3>Total Fees Balance</h3>
                    <p>KSH {{ child.balance|floatformat:2 }}</p>
                </div>
            </div>

            <!-- Performance Table -->
            <div class="table-section">
                <h2>Recent Exam Results</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in child.latest_results %}
                            <tr>
                                <td>{{ result.subject }}</td>
                                <td>{{ result.score }}</td>
                                <td>{{ result.grade_object.grade }}</td>
                                <td>{{ result.grade_object.remark }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4">No results available</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
            <p>No children linked to this account.</p>
        {% endfor %}

        <!-- Announcements -->
<div class="table-section" style="margin-top: 20px;">
    <h2>Latest Announcements</h2>
     <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Announcement</th>
                        <th>Author</th>
                        <th>Created On</th>
                    </tr>
                </thead>
                <tbody>
                    {% for announcement in announcements %}
                        <tr>
                            <td>{{ announcement.title }}</td>
                            <td>{{ announcement.message|truncatechars:120 }}</td>
                                <td>{{ announcement.author }}</td>

                            <td>{{ announcement.created_on|date:"d M Y" }}</td>

                        </tr>
                    {% empty %}
                        <tr><td colspan="3">No Recent Announcements</td></tr>
                    {% endfor %}
                </tbody>
     </table>
</div>


        <!-- Events -->
        <div class="table-section" style="margin-top: 20px;">
            <h2>Upcoming Events</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Event</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                        <tr>
                            <td>{{ event.date|date:"d M Y" }}</td>
                            <td>{{ event.name }}</td>
                            <td>{{ event.location }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="3">No upcoming events</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Messages -->
        <div class="table-section" style="margin-top: 20px;">
            <h2>Messages</h2>
            <ul>
                {% for msg in messages %}
                    <li>
                        <strong>{{ msg.title }}</strong> ({{ msg.created_at|date:"d M Y" }})<br>
                        {{ msg.content|truncatechars:100 }}
                    </li>
                {% empty %}
                    <li>No messages available</li>
                {% endfor %}
            </ul>
        </div>
        {% endblock %}
    </div>
</div>
{% endblock %}
